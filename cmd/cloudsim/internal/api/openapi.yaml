openapi: 3.0.3
info:
  title: Cloudsim Management API
  description: REST API for managing cloudsim entities (Sites, Nodes, ConfigVersions, Deployments)
  version: 1.0.0

servers:
  - url: /api/v1/management
  - url: /api/v1

paths:
  /check-in:
    post:
      summary: Node check-in
      operationId: checkIn
      tags: [CheckIn]
      description: >-
        Authenticates a node using its bearer secret, records a check-in,
        and returns the newest active deployment (if any).
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckInRequest'
      responses:
        '200':
          description: Check-in recorded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckInResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /sites:
    get:
      summary: List sites
      operationId: listSites
      tags: [Sites]
      parameters:
        - $ref: '#/components/parameters/pageToken'
        - $ref: '#/components/parameters/pageSize'
      responses:
        '200':
          description: List of sites
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SiteList'
        '400':
          $ref: '#/components/responses/BadRequest'
    post:
      summary: Create site
      operationId: createSite
      tags: [Sites]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSiteRequest'
      responses:
        '201':
          description: Site created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Site'
        '400':
          $ref: '#/components/responses/BadRequest'

  /sites/{id}:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      summary: Get site
      operationId: getSite
      tags: [Sites]
      responses:
        '200':
          description: Site details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Site'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Update site
      operationId: updateSite
      tags: [Sites]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSiteRequest'
      responses:
        '200':
          description: Site updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Site'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Delete site
      operationId: deleteSite
      tags: [Sites]
      responses:
        '204':
          description: Site deleted
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /nodes:
    get:
      summary: List nodes
      operationId: listNodes
      tags: [Nodes]
      parameters:
        - $ref: '#/components/parameters/pageToken'
        - $ref: '#/components/parameters/pageSize'
        - name: siteId
          in: query
          description: Filter by site ID
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: List of nodes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeList'
        '400':
          $ref: '#/components/responses/BadRequest'
    post:
      summary: Create node
      operationId: createNode
      tags: [Nodes]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateNodeRequest'
      responses:
        '201':
          description: Node created. The response includes the initial Node secret.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateNodeResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /nodes/{id}:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      summary: Get node
      operationId: getNode
      tags: [Nodes]
      responses:
        '200':
          description: Node details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Node'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Update node
      operationId: updateNode
      tags: [Nodes]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateNodeRequest'
      responses:
        '200':
          description: Node updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Node'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Delete node
      operationId: deleteNode
      tags: [Nodes]
      responses:
        '204':
          description: Node deleted
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /nodes/{id}/rotate-secret:
    parameters:
      - $ref: '#/components/parameters/id'
    post:
      summary: Rotate node secret
      operationId: rotateNodeSecret
      tags: [Nodes]
      description: >-
        Generates a new secret for the node. The previous secret is invalidated.
        The new secret cannot be retrieved later.
      responses:
        '200':
          description: The updated Node, including the new secret.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateNodeResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /nodes/{nodeId}/check-ins:
    parameters:
      - $ref: '#/components/parameters/nodeId'
    get:
      summary: List node check-ins
      operationId: listNodeCheckIns
      tags: [NodeCheckIns]
      parameters:
        - $ref: '#/components/parameters/pageToken'
        - $ref: '#/components/parameters/pageSize'
      responses:
        '200':
          description: List of check-ins for the node
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeCheckInList'
        '400':
          $ref: '#/components/responses/BadRequest'

  /nodes/{nodeId}/check-ins/{id}:
    parameters:
      - $ref: '#/components/parameters/nodeId'
      - $ref: '#/components/parameters/id'
    get:
      summary: Get node check-in
      operationId: getNodeCheckIn
      tags: [NodeCheckIns]
      responses:
        '200':
          description: Check-in details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeCheckIn'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /config-versions:
    get:
      summary: List config versions
      operationId: listConfigVersions
      tags: [ConfigVersions]
      parameters:
        - $ref: '#/components/parameters/pageToken'
        - $ref: '#/components/parameters/pageSize'
        - name: nodeId
          in: query
          description: Filter by node ID
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: List of config versions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigVersionList'
        '400':
          $ref: '#/components/responses/BadRequest'
    post:
      summary: Create config version
      operationId: createConfigVersion
      tags: [ConfigVersions]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConfigVersionRequest'
      responses:
        '201':
          description: Config version created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigVersion'
        '400':
          $ref: '#/components/responses/BadRequest'

  /config-versions/{id}:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      summary: Get config version
      operationId: getConfigVersion
      tags: [ConfigVersions]
      responses:
        '200':
          description: Config version details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigVersion'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Delete config version
      operationId: deleteConfigVersion
      tags: [ConfigVersions]
      responses:
        '204':
          description: Config version deleted
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /config-versions/{id}/payload:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      summary: Download config version payload
      operationId: getConfigVersionPayload
      tags: [ConfigVersions]
      responses:
        '200':
          description: Config payload binary data
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /deployments:
    get:
      summary: List deployments
      operationId: listDeployments
      tags: [Deployments]
      parameters:
        - $ref: '#/components/parameters/pageToken'
        - $ref: '#/components/parameters/pageSize'
        - name: nodeId
          in: query
          description: Filter by node ID (via config version)
          schema:
            type: integer
            format: int64
        - name: configVersionId
          in: query
          description: Filter by config version ID
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: List of deployments
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeploymentList'
        '400':
          $ref: '#/components/responses/BadRequest'
    post:
      summary: Create deployment
      operationId: createDeployment
      tags: [Deployments]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDeploymentRequest'
      responses:
        '201':
          description: Deployment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Deployment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'

  /deployments/{id}:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      summary: Get deployment
      operationId: getDeployment
      tags: [Deployments]
      responses:
        '200':
          description: Deployment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Deployment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      summary: Update deployment status
      operationId: updateDeploymentStatus
      tags: [Deployments]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateDeploymentStatusRequest'
      responses:
        '200':
          description: Deployment updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Deployment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Delete deployment
      operationId: deleteDeployment
      tags: [Deployments]
      responses:
        '204':
          description: Deployment deleted
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  parameters:
    id:
      name: id
      in: path
      required: true
      schema:
        type: integer
        format: int64
    nodeId:
      name: nodeId
      in: path
      required: true
      schema:
        type: integer
        format: int64
    pageToken:
      name: pageToken
      in: query
      description: Page token for pagination (opaque string)
      schema:
        type: string
    pageSize:
      name: pageSize
      in: query
      description: Number of items per page (default 50, max 1000)
      schema:
        type: integer
        minimum: 1
        maximum: 1000
        default: 50

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Invalid or missing authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Conflict:
      description: Request conflicts with current state
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    Error:
      type: object
      required: [error, message]
      properties:
        error:
          type: string
          example: invalid_request
        message:
          type: string
          example: invalid request

    Site:
      type: object
      required: [id, name, createTime]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        createTime:
          type: string
          format: date-time

    SiteList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Site'
        nextPageToken:
          type: string

    CreateSiteRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string

    UpdateSiteRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string

    Node:
      type: object
      required: [id, hostname, siteId, createTime]
      properties:
        id:
          type: integer
          format: int64
        hostname:
          type: string
        siteId:
          type: integer
          format: int64
        createTime:
          type: string
          format: date-time

    NodeList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Node'
        nextPageToken:
          type: string

    CreateNodeRequest:
      type: object
      required: [hostname, siteId]
      properties:
        hostname:
          type: string
        siteId:
          type: integer
          format: int64

    UpdateNodeRequest:
      type: object
      required: [hostname, siteId]
      properties:
        hostname:
          type: string
        siteId:
          type: integer
          format: int64

    CreateNodeResponse:
      description: >-
        Response from creating a node or rotating its secret.
        Contains the node fields plus an authentication secret.
      allOf:
        - $ref: '#/components/schemas/Node'
        - type: object
          required: [secret]
          properties:
            secret:
              type: string
              format: byte
              description: >-
                Secret (32 bytes, base64-encoded). Secrets are only returned
                from the API call that generates them. The client must store
                the secret as it cannot be retrieved later.

    NodeCheckIn:
      type: object
      required: [id, nodeId, checkInTime]
      properties:
        id:
          type: integer
          format: int64
        nodeId:
          type: integer
          format: int64
        checkInTime:
          type: string
          format: date-time
        currentDeploymentId:
          type: integer
          format: int64
          nullable: true
        installingDeploymentId:
          type: integer
          format: int64
          nullable: true

    NodeCheckInList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/NodeCheckIn'
        nextPageToken:
          type: string

    ConfigVersion:
      type: object
      required: [id, nodeId, payloadUrl, createTime]
      properties:
        id:
          type: integer
          format: int64
        nodeId:
          type: integer
          format: int64
        description:
          type: string
        payloadUrl:
          type: string
          format: uri
          description: Fully qualified URL to download the raw config payload
          example: https://api.example.com/api/v1/management/config-versions/1/payload
        createTime:
          type: string
          format: date-time

    ConfigVersionList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ConfigVersion'
        nextPageToken:
          type: string

    CreateConfigVersionRequest:
      type: object
      required: [nodeId, payload]
      properties:
        nodeId:
          type: integer
          format: int64
        description:
          type: string
        payload:
          type: string
          format: byte
          description: Base64-encoded binary payload

    Deployment:
      type: object
      required: [id, configVersionId, status, startTime]
      properties:
        id:
          type: integer
          format: int64
        configVersionId:
          type: integer
          format: int64
        status:
          type: string
          enum: [PENDING, IN_PROGRESS, COMPLETED, FAILED, CANCELLED]
        startTime:
          type: string
          format: date-time
        finishedTime:
          type: string
          format: date-time
          nullable: true
        reason:
          type: string
          nullable: true
          description: Optional reason for failure or cancellation

    DeploymentList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Deployment'
        nextPageToken:
          type: string

    CreateDeploymentRequest:
      type: object
      required: [configVersionId]
      properties:
        configVersionId:
          type: integer
          format: int64
        status:
          type: string
          enum: [PENDING]
          default: PENDING
          description: Deployment status. Must be PENDING if provided. Defaults to PENDING if omitted.

    UpdateDeploymentStatusRequest:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [PENDING, IN_PROGRESS, COMPLETED, FAILED, CANCELLED]
        reason:
          type: string
          description: Optional reason, typically used for FAILED or CANCELLED status

    CheckInRequest:
      type: object
      properties:
        currentDeployment:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/CheckInDeploymentRef'
          description: The deployment currently running on this node
        installingDeployment:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/CheckInDeploymentRef'
          description: The deployment currently being installed on this node
        failedDeployment:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/CheckInFailedDeployment'
          description: A deployment that just failed; triggers status update to FAILED

    CheckInDeploymentRef:
      type: object
      required: [id]
      properties:
        id:
          type: integer
          format: int64

    CheckInFailedDeployment:
      type: object
      required: [id]
      properties:
        id:
          type: integer
          format: int64
        reason:
          type: string
          description: Reason the deployment failed

    CheckInResponse:
      type: object
      required: [checkIn]
      properties:
        checkIn:
          $ref: '#/components/schemas/NodeCheckIn'
        latestConfig:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/LatestConfig'

    LatestConfig:
      description: The newest active deployment and its associated config version, returned as part of a check-in response.
      type: object
      required: [deployment, configVersion]
      properties:
        deployment:
          $ref: '#/components/schemas/Deployment'
        configVersion:
          $ref: '#/components/schemas/ConfigVersion'

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: Base64-encoded node secret

tags:
  - name: CheckIn
    description: Node check-in endpoint (authenticated by bearer secret)
  - name: Sites
    description: Physical location management
  - name: Nodes
    description: BOS controller management
  - name: NodeCheckIns
    description: Node check-in tracking
  - name: ConfigVersions
    description: Versioned configuration management
  - name: Deployments
    description: Configuration deployment tracking

// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: queries.sql

package queries

import (
	"context"
	"database/sql"
)

const countDeployments = `-- name: CountDeployments :one
SELECT COUNT(*) AS count
FROM deployments
`

func (q *Queries) CountDeployments(ctx context.Context) (int64, error) {
	row := q.db.QueryRowContext(ctx, countDeployments)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countNodes = `-- name: CountNodes :one
SELECT COUNT(*) AS count
FROM nodes
`

func (q *Queries) CountNodes(ctx context.Context) (int64, error) {
	row := q.db.QueryRowContext(ctx, countNodes)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countNodesBySite = `-- name: CountNodesBySite :one
SELECT COUNT(*) AS count
FROM nodes
WHERE site_id = ?1
`

func (q *Queries) CountNodesBySite(ctx context.Context, siteID int64) (int64, error) {
	row := q.db.QueryRowContext(ctx, countNodesBySite, siteID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countSites = `-- name: CountSites :one
SELECT COUNT(*) AS count
FROM sites
`

func (q *Queries) CountSites(ctx context.Context) (int64, error) {
	row := q.db.QueryRowContext(ctx, countSites)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createConfigVersion = `-- name: CreateConfigVersion :one

INSERT INTO config_versions (node_id, description, payload, create_time)
VALUES (?1, ?2, ?3, datetime('now', 'subsec'))
RETURNING id, node_id, description, payload, create_time
`

type CreateConfigVersionParams struct {
	NodeID      int64
	Description sql.NullString
	Payload     []byte
}

// Config Versions
func (q *Queries) CreateConfigVersion(ctx context.Context, arg CreateConfigVersionParams) (ConfigVersion, error) {
	row := q.db.QueryRowContext(ctx, createConfigVersion, arg.NodeID, arg.Description, arg.Payload)
	var i ConfigVersion
	err := row.Scan(
		&i.ID,
		&i.NodeID,
		&i.Description,
		&i.Payload,
		&i.CreateTime,
	)
	return i, err
}

const createDeployment = `-- name: CreateDeployment :one

INSERT INTO deployments (config_version_id, status, start_time, finished_time)
VALUES (?1, ?2, datetime('now', 'subsec'), NULL)
RETURNING id, config_version_id, status, start_time, finished_time
`

type CreateDeploymentParams struct {
	ConfigVersionID int64
	Status          string
}

// Deployments
func (q *Queries) CreateDeployment(ctx context.Context, arg CreateDeploymentParams) (Deployment, error) {
	row := q.db.QueryRowContext(ctx, createDeployment, arg.ConfigVersionID, arg.Status)
	var i Deployment
	err := row.Scan(
		&i.ID,
		&i.ConfigVersionID,
		&i.Status,
		&i.StartTime,
		&i.FinishedTime,
	)
	return i, err
}

const createNode = `-- name: CreateNode :one

INSERT INTO nodes (hostname, site_id, secret_hash, create_time)
VALUES (?1, ?2, ?3, datetime('now', 'subsec'))
RETURNING id, hostname, site_id, secret_hash, create_time
`

type CreateNodeParams struct {
	Hostname   string
	SiteID     int64
	SecretHash []byte
}

// Nodes
func (q *Queries) CreateNode(ctx context.Context, arg CreateNodeParams) (Node, error) {
	row := q.db.QueryRowContext(ctx, createNode, arg.Hostname, arg.SiteID, arg.SecretHash)
	var i Node
	err := row.Scan(
		&i.ID,
		&i.Hostname,
		&i.SiteID,
		&i.SecretHash,
		&i.CreateTime,
	)
	return i, err
}

const createNodeCheckIn = `-- name: CreateNodeCheckIn :one

INSERT INTO node_check_ins (node_id, check_in_time)
VALUES (?1, datetime('now', 'subsec'))
RETURNING id, node_id, check_in_time
`

// Node Check-Ins
func (q *Queries) CreateNodeCheckIn(ctx context.Context, nodeID int64) (NodeCheckIn, error) {
	row := q.db.QueryRowContext(ctx, createNodeCheckIn, nodeID)
	var i NodeCheckIn
	err := row.Scan(&i.ID, &i.NodeID, &i.CheckInTime)
	return i, err
}

const createSite = `-- name: CreateSite :one

INSERT INTO sites (name, create_time)
VALUES (?1, datetime('now', 'subsec'))
RETURNING id, name, create_time
`

// Sites
func (q *Queries) CreateSite(ctx context.Context, name string) (Site, error) {
	row := q.db.QueryRowContext(ctx, createSite, name)
	var i Site
	err := row.Scan(&i.ID, &i.Name, &i.CreateTime)
	return i, err
}

const deleteConfigVersion = `-- name: DeleteConfigVersion :execrows
DELETE FROM config_versions
WHERE id = ?1
`

func (q *Queries) DeleteConfigVersion(ctx context.Context, id int64) (int64, error) {
	result, err := q.db.ExecContext(ctx, deleteConfigVersion, id)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const deleteDeployment = `-- name: DeleteDeployment :execrows
DELETE FROM deployments
WHERE id = ?1
`

func (q *Queries) DeleteDeployment(ctx context.Context, id int64) (int64, error) {
	result, err := q.db.ExecContext(ctx, deleteDeployment, id)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const deleteNode = `-- name: DeleteNode :execrows
DELETE FROM nodes
WHERE id = ?1
`

func (q *Queries) DeleteNode(ctx context.Context, id int64) (int64, error) {
	result, err := q.db.ExecContext(ctx, deleteNode, id)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const deleteNodeCheckIn = `-- name: DeleteNodeCheckIn :execrows
DELETE FROM node_check_ins
WHERE id = ?1
`

func (q *Queries) DeleteNodeCheckIn(ctx context.Context, id int64) (int64, error) {
	result, err := q.db.ExecContext(ctx, deleteNodeCheckIn, id)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const deleteSite = `-- name: DeleteSite :execrows
DELETE FROM sites
WHERE id = ?1
`

func (q *Queries) DeleteSite(ctx context.Context, id int64) (int64, error) {
	result, err := q.db.ExecContext(ctx, deleteSite, id)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const getActiveDeploymentByNode = `-- name: GetActiveDeploymentByNode :one
SELECT d.id, d.config_version_id, d.status, d.start_time, d.finished_time
FROM deployments d
JOIN config_versions cv ON d.config_version_id = cv.id
WHERE cv.node_id = ?1 AND d.status IN ('PENDING', 'IN_PROGRESS')
ORDER BY d.id DESC
LIMIT 1
`

func (q *Queries) GetActiveDeploymentByNode(ctx context.Context, nodeID int64) (Deployment, error) {
	row := q.db.QueryRowContext(ctx, getActiveDeploymentByNode, nodeID)
	var i Deployment
	err := row.Scan(
		&i.ID,
		&i.ConfigVersionID,
		&i.Status,
		&i.StartTime,
		&i.FinishedTime,
	)
	return i, err
}

const getConfigVersion = `-- name: GetConfigVersion :one
SELECT id, node_id, description, payload, create_time
FROM config_versions
WHERE id = ?1
`

func (q *Queries) GetConfigVersion(ctx context.Context, id int64) (ConfigVersion, error) {
	row := q.db.QueryRowContext(ctx, getConfigVersion, id)
	var i ConfigVersion
	err := row.Scan(
		&i.ID,
		&i.NodeID,
		&i.Description,
		&i.Payload,
		&i.CreateTime,
	)
	return i, err
}

const getDeployment = `-- name: GetDeployment :one
SELECT id, config_version_id, status, start_time, finished_time
FROM deployments
WHERE id = ?1
`

func (q *Queries) GetDeployment(ctx context.Context, id int64) (Deployment, error) {
	row := q.db.QueryRowContext(ctx, getDeployment, id)
	var i Deployment
	err := row.Scan(
		&i.ID,
		&i.ConfigVersionID,
		&i.Status,
		&i.StartTime,
		&i.FinishedTime,
	)
	return i, err
}

const getNode = `-- name: GetNode :one
SELECT id, hostname, site_id, secret_hash, create_time
FROM nodes
WHERE id = ?1
`

func (q *Queries) GetNode(ctx context.Context, id int64) (Node, error) {
	row := q.db.QueryRowContext(ctx, getNode, id)
	var i Node
	err := row.Scan(
		&i.ID,
		&i.Hostname,
		&i.SiteID,
		&i.SecretHash,
		&i.CreateTime,
	)
	return i, err
}

const getNodeBySecretHash = `-- name: GetNodeBySecretHash :one
SELECT id, hostname, site_id, secret_hash, create_time FROM nodes WHERE secret_hash = ?1
`

func (q *Queries) GetNodeBySecretHash(ctx context.Context, secretHash []byte) (Node, error) {
	row := q.db.QueryRowContext(ctx, getNodeBySecretHash, secretHash)
	var i Node
	err := row.Scan(
		&i.ID,
		&i.Hostname,
		&i.SiteID,
		&i.SecretHash,
		&i.CreateTime,
	)
	return i, err
}

const getNodeCheckIn = `-- name: GetNodeCheckIn :one
SELECT id, node_id, check_in_time
FROM node_check_ins
WHERE id = ?1
`

func (q *Queries) GetNodeCheckIn(ctx context.Context, id int64) (NodeCheckIn, error) {
	row := q.db.QueryRowContext(ctx, getNodeCheckIn, id)
	var i NodeCheckIn
	err := row.Scan(&i.ID, &i.NodeID, &i.CheckInTime)
	return i, err
}

const getSite = `-- name: GetSite :one
SELECT id, name, create_time
FROM sites
WHERE id = ?1
`

func (q *Queries) GetSite(ctx context.Context, id int64) (Site, error) {
	row := q.db.QueryRowContext(ctx, getSite, id)
	var i Site
	err := row.Scan(&i.ID, &i.Name, &i.CreateTime)
	return i, err
}

const listConfigVersions = `-- name: ListConfigVersions :many
SELECT id, node_id, description, payload, create_time
FROM config_versions
WHERE id > ?1
ORDER BY id
LIMIT ?2
`

type ListConfigVersionsParams struct {
	AfterID int64
	Limit   int64
}

func (q *Queries) ListConfigVersions(ctx context.Context, arg ListConfigVersionsParams) ([]ConfigVersion, error) {
	rows, err := q.db.QueryContext(ctx, listConfigVersions, arg.AfterID, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []ConfigVersion
	for rows.Next() {
		var i ConfigVersion
		if err := rows.Scan(
			&i.ID,
			&i.NodeID,
			&i.Description,
			&i.Payload,
			&i.CreateTime,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listConfigVersionsByNode = `-- name: ListConfigVersionsByNode :many
SELECT id, node_id, description, payload, create_time
FROM config_versions
WHERE node_id = ?1 AND id > ?2
ORDER BY id
LIMIT ?3
`

type ListConfigVersionsByNodeParams struct {
	NodeID  int64
	AfterID int64
	Limit   int64
}

func (q *Queries) ListConfigVersionsByNode(ctx context.Context, arg ListConfigVersionsByNodeParams) ([]ConfigVersion, error) {
	rows, err := q.db.QueryContext(ctx, listConfigVersionsByNode, arg.NodeID, arg.AfterID, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []ConfigVersion
	for rows.Next() {
		var i ConfigVersion
		if err := rows.Scan(
			&i.ID,
			&i.NodeID,
			&i.Description,
			&i.Payload,
			&i.CreateTime,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listDeployments = `-- name: ListDeployments :many
SELECT id, config_version_id, status, start_time, finished_time
FROM deployments
WHERE id > ?1
ORDER BY id
LIMIT ?2
`

type ListDeploymentsParams struct {
	AfterID int64
	Limit   int64
}

func (q *Queries) ListDeployments(ctx context.Context, arg ListDeploymentsParams) ([]Deployment, error) {
	rows, err := q.db.QueryContext(ctx, listDeployments, arg.AfterID, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Deployment
	for rows.Next() {
		var i Deployment
		if err := rows.Scan(
			&i.ID,
			&i.ConfigVersionID,
			&i.Status,
			&i.StartTime,
			&i.FinishedTime,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listDeploymentsByConfigVersion = `-- name: ListDeploymentsByConfigVersion :many
SELECT id, config_version_id, status, start_time, finished_time
FROM deployments
WHERE config_version_id = ?1 AND id > ?2
ORDER BY id
LIMIT ?3
`

type ListDeploymentsByConfigVersionParams struct {
	ConfigVersionID int64
	AfterID         int64
	Limit           int64
}

func (q *Queries) ListDeploymentsByConfigVersion(ctx context.Context, arg ListDeploymentsByConfigVersionParams) ([]Deployment, error) {
	rows, err := q.db.QueryContext(ctx, listDeploymentsByConfigVersion, arg.ConfigVersionID, arg.AfterID, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Deployment
	for rows.Next() {
		var i Deployment
		if err := rows.Scan(
			&i.ID,
			&i.ConfigVersionID,
			&i.Status,
			&i.StartTime,
			&i.FinishedTime,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listDeploymentsByNode = `-- name: ListDeploymentsByNode :many
SELECT d.id, d.config_version_id, d.status, d.start_time, d.finished_time
FROM deployments d
JOIN config_versions cv ON d.config_version_id = cv.id
WHERE cv.node_id = ?1 AND d.id > ?2
ORDER BY d.id
LIMIT ?3
`

type ListDeploymentsByNodeParams struct {
	NodeID  int64
	AfterID int64
	Limit   int64
}

func (q *Queries) ListDeploymentsByNode(ctx context.Context, arg ListDeploymentsByNodeParams) ([]Deployment, error) {
	rows, err := q.db.QueryContext(ctx, listDeploymentsByNode, arg.NodeID, arg.AfterID, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Deployment
	for rows.Next() {
		var i Deployment
		if err := rows.Scan(
			&i.ID,
			&i.ConfigVersionID,
			&i.Status,
			&i.StartTime,
			&i.FinishedTime,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listNodeCheckInsByNode = `-- name: ListNodeCheckInsByNode :many
SELECT id, node_id, check_in_time
FROM node_check_ins
WHERE node_id = ?1 AND id > ?2
ORDER BY id
LIMIT ?3
`

type ListNodeCheckInsByNodeParams struct {
	NodeID  int64
	AfterID int64
	Limit   int64
}

func (q *Queries) ListNodeCheckInsByNode(ctx context.Context, arg ListNodeCheckInsByNodeParams) ([]NodeCheckIn, error) {
	rows, err := q.db.QueryContext(ctx, listNodeCheckInsByNode, arg.NodeID, arg.AfterID, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []NodeCheckIn
	for rows.Next() {
		var i NodeCheckIn
		if err := rows.Scan(&i.ID, &i.NodeID, &i.CheckInTime); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listNodes = `-- name: ListNodes :many
SELECT id, hostname, site_id, secret_hash, create_time
FROM nodes
WHERE id > ?1
ORDER BY id
LIMIT ?2
`

type ListNodesParams struct {
	AfterID int64
	Limit   int64
}

func (q *Queries) ListNodes(ctx context.Context, arg ListNodesParams) ([]Node, error) {
	rows, err := q.db.QueryContext(ctx, listNodes, arg.AfterID, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Node
	for rows.Next() {
		var i Node
		if err := rows.Scan(
			&i.ID,
			&i.Hostname,
			&i.SiteID,
			&i.SecretHash,
			&i.CreateTime,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listNodesBySite = `-- name: ListNodesBySite :many
SELECT id, hostname, site_id, secret_hash, create_time
FROM nodes
WHERE site_id = ?1 AND id > ?2
ORDER BY id
LIMIT ?3
`

type ListNodesBySiteParams struct {
	SiteID  int64
	AfterID int64
	Limit   int64
}

func (q *Queries) ListNodesBySite(ctx context.Context, arg ListNodesBySiteParams) ([]Node, error) {
	rows, err := q.db.QueryContext(ctx, listNodesBySite, arg.SiteID, arg.AfterID, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Node
	for rows.Next() {
		var i Node
		if err := rows.Scan(
			&i.ID,
			&i.Hostname,
			&i.SiteID,
			&i.SecretHash,
			&i.CreateTime,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listSites = `-- name: ListSites :many
SELECT id, name, create_time
FROM sites
WHERE id > ?1
ORDER BY id
LIMIT ?2
`

type ListSitesParams struct {
	AfterID int64
	Limit   int64
}

func (q *Queries) ListSites(ctx context.Context, arg ListSitesParams) ([]Site, error) {
	rows, err := q.db.QueryContext(ctx, listSites, arg.AfterID, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Site
	for rows.Next() {
		var i Site
		if err := rows.Scan(&i.ID, &i.Name, &i.CreateTime); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateDeploymentStatus = `-- name: UpdateDeploymentStatus :one
UPDATE deployments
SET status = ?1,
    finished_time = CASE
        WHEN ?1 = 'COMPLETED' OR ?1 = 'FAILED' THEN datetime('now', 'subsec')
        ELSE finished_time
    END
WHERE id = ?2
RETURNING id, config_version_id, status, start_time, finished_time
`

type UpdateDeploymentStatusParams struct {
	Status string
	ID     int64
}

func (q *Queries) UpdateDeploymentStatus(ctx context.Context, arg UpdateDeploymentStatusParams) (Deployment, error) {
	row := q.db.QueryRowContext(ctx, updateDeploymentStatus, arg.Status, arg.ID)
	var i Deployment
	err := row.Scan(
		&i.ID,
		&i.ConfigVersionID,
		&i.Status,
		&i.StartTime,
		&i.FinishedTime,
	)
	return i, err
}

const updateNode = `-- name: UpdateNode :one
UPDATE nodes
SET hostname = ?1, site_id = ?2
WHERE id = ?3
RETURNING id, hostname, site_id, secret_hash, create_time
`

type UpdateNodeParams struct {
	Hostname string
	SiteID   int64
	ID       int64
}

func (q *Queries) UpdateNode(ctx context.Context, arg UpdateNodeParams) (Node, error) {
	row := q.db.QueryRowContext(ctx, updateNode, arg.Hostname, arg.SiteID, arg.ID)
	var i Node
	err := row.Scan(
		&i.ID,
		&i.Hostname,
		&i.SiteID,
		&i.SecretHash,
		&i.CreateTime,
	)
	return i, err
}

const updateNodeSecretHash = `-- name: UpdateNodeSecretHash :exec
UPDATE nodes SET secret_hash = ?1 WHERE id = ?2
`

type UpdateNodeSecretHashParams struct {
	SecretHash []byte
	ID         int64
}

func (q *Queries) UpdateNodeSecretHash(ctx context.Context, arg UpdateNodeSecretHashParams) error {
	_, err := q.db.ExecContext(ctx, updateNodeSecretHash, arg.SecretHash, arg.ID)
	return err
}

const updateSite = `-- name: UpdateSite :one
UPDATE sites
SET name = ?1
WHERE id = ?2
RETURNING id, name, create_time
`

type UpdateSiteParams struct {
	Name string
	ID   int64
}

func (q *Queries) UpdateSite(ctx context.Context, arg UpdateSiteParams) (Site, error) {
	row := q.db.QueryRowContext(ctx, updateSite, arg.Name, arg.ID)
	var i Site
	err := row.Scan(&i.ID, &i.Name, &i.CreateTime)
	return i, err
}
